<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è¯­éŸ³åŠ©æ‰‹</title>
</head>
<body>
<h1>è¯­éŸ³åŠ©æ‰‹ï¼ˆæ”¯æŒå”¤é†’è¯ï¼‰</h1>
<audio id="responseAudio" controls></audio>
<p id="status">é¡µé¢åŠ è½½ä¸­...</p>

<script>
window.onload = async () => {
    const status = document.getElementById("status");
    const audio = document.getElementById("responseAudio");
    const ws = new WebSocket(`ws://${location.host}/ws`);

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        let audioChunks = [];

        status.innerText = "ğŸ¤ è‡ªåŠ¨ç›‘å¬ä¸­...";

        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
                audioChunks.push(e.data);
            }
        };

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const arrayBuffer = await audioBlob.arrayBuffer();
            ws.send(arrayBuffer);
            audioChunks = [];
        };

        setInterval(() => {
            if (mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                mediaRecorder.start();
            }
        }, 3000);

        mediaRecorder.start();

    } catch (err) {
        status.innerText = "âŒ æ— æ³•è®¿é—®éº¦å…‹é£ï¼š" + err.message;
    }

    ws.onmessage = event => {
        const data = JSON.parse(event.data);
        if (data.audio_url) {
            audio.src = data.audio_url;
            audio.play();
            status.innerText = "âœ… æ”¶åˆ°å›å¤ï¼Œæ­£åœ¨æ’­æ”¾...";
        } else if (data.error) {
            status.innerText = "âš ï¸ " + data.error;
        } else if (data.status) {
            status.innerText = data.status;
        }
    };
};
</script>
</body>
</html>
